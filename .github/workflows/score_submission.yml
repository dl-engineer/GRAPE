name: Score Submission

on:
  pull_request_target:
    paths:
      - 'submissions/inbox/**'

jobs:
  score:
    runs-on: ubuntu-latest
    steps:
      # Checkout base repo (has decrypt scripts, validation, etc.)
      - uses: actions/checkout@v4

      # Fetch ONLY the submitted .enc file from the PR fork
      - name: Checkout PR submission file
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr-submission
          sparse-checkout: submissions/inbox
          sparse-checkout-cone-mode: true

      - name: Copy submission into workspace
        run: |
          cp -r pr-submission/submissions/inbox/* submissions/inbox/ 2>/dev/null || true
          rm -rf pr-submission

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pandas scikit-learn cryptography

      - name: Detect team and decrypt
        id: team
        env:
          SUBMISSION_PRIVATE_KEY: ${{ secrets.SUBMISSION_PRIVATE_KEY }}
        run: |
          ENC=$(find submissions/inbox -name "*.enc" | head -1)
          if [ -z "$ENC" ]; then
            echo "::error::No .enc file found in submissions/inbox/"
            exit 1
          fi
          TEAM=$(echo "$ENC" | sed 's|submissions/inbox/||' | cut -d'/' -f1)
          python encryption/decrypt.py "$ENC" /tmp/predictions.csv
          echo "name=$TEAM" >> "$GITHUB_OUTPUT"

      - name: Enforce one-submission policy
        run: |
          TEAM="${{ steps.team.outputs.name }}"
          if grep -qi ",$TEAM," leaderboard/leaderboard.csv 2>/dev/null; then
            echo "::error::Team '$TEAM' has already submitted."
            exit 1
          fi

      - name: Validate submission format
        run: python competition/validate_submission.py /tmp/predictions.csv data/public/test_data.csv

      - name: Evaluate
        run: |
          echo "${{ secrets.TEST_LABELS_CSV }}" > /tmp/test_labels.csv
          python competition/evaluate.py /tmp/predictions.csv /tmp/test_labels.csv
